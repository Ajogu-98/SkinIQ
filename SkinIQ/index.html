<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Skinsight â€” Ingredient Analyzer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400;1,600&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&display=swap" rel="stylesheet">

<style>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOKENS & RESET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --cream:   #F6F2EC;
  --ivory:   #ECE6DC;
  --parchmt: #E4DDD1;
  --forest:  #263D2E;
  --moss:    #3D5C43;
  --sage:    #7EA87A;
  --sage-lt: #C9DEC6;
  --blush:   #C97B6E;
  --blush-lt:#EDCFC9;
  --gold:    #A8813E;
  --charcoal:#1E1E1E;
  --ink:     #2D2A26;
  --grey:    #736D66;
  --grey-lt: #ADA79F;

  --safe-bg:    #EBF3E7; --safe-fg:    #1F5C18;
  --caution-bg: #FBF2E4; --caution-fg: #7A4A00;
  --flag-bg:    #FBE7E5; --flag-fg:    #7A1F14;
  --unknown-bg: #EDEBEB; --unknown-fg: #555;

  --r-md: 12px; --r-lg: 18px; --r-xl: 24px;
  --shadow: 0 2px 16px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.10);
  --transition: 0.22s ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  background:var(--cream);
  color:var(--ink);
  font-family:'DM Sans',sans-serif;
  font-weight:300;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
}

/* â”€â”€ BACKGROUND ORBS â”€â”€ */
.bg-orb{position:fixed;border-radius:50%;pointer-events:none;z-index:0;}
.bg-orb-1{width:700px;height:700px;top:-200px;right:-200px;
  background:radial-gradient(circle,rgba(126,168,122,0.10) 0%,transparent 70%);}
.bg-orb-2{width:600px;height:600px;bottom:-150px;left:-150px;
  background:radial-gradient(circle,rgba(201,123,110,0.09) 0%,transparent 70%);}
.bg-orb-3{width:400px;height:400px;top:50%;left:50%;transform:translate(-50%,-50%);
  background:radial-gradient(circle,rgba(168,129,62,0.05) 0%,transparent 70%);}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   HEADER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  position:relative;z-index:10;
  padding:44px 64px 36px;
  display:flex;align-items:flex-end;gap:0;justify-content:space-between;flex-wrap:wrap;
  border-bottom:1px solid rgba(38,61,46,0.10);
}
.header-left{}
.logo-eyebrow{
  font-size:10px;font-weight:500;letter-spacing:0.22em;text-transform:uppercase;
  color:var(--moss);margin-bottom:8px;display:flex;align-items:center;gap:8px;
}
.logo-eyebrow::before{content:'';width:24px;height:1px;background:var(--sage);}
.logo-title{
  font-family:'Cormorant Garamond',serif;
  font-size:52px;font-weight:300;line-height:1;
  color:var(--forest);letter-spacing:-0.02em;
}
.logo-title em{font-style:italic;color:var(--blush);}
.header-tagline{
  font-size:13px;color:var(--grey);margin-top:10px;max-width:300px;line-height:1.65;
}
.header-badge{
  background:var(--forest);color:white;
  padding:8px 18px;border-radius:30px;
  font-size:11px;font-weight:500;letter-spacing:0.08em;
  display:flex;align-items:center;gap:7px;
  align-self:center;white-space:nowrap;
}
.header-badge .dot{width:7px;height:7px;border-radius:50%;background:var(--sage);
  animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(0.8)}}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MAIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
main{
  position:relative;z-index:5;
  max-width:1100px;margin:0 auto;
  padding:48px 64px 100px;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INPUT CARD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-card{
  background:white;
  border:1px solid rgba(38,61,46,0.10);
  border-radius:var(--r-xl);
  padding:40px;
  box-shadow:var(--shadow);
  margin-bottom:40px;
}

/* â”€â”€ TABS â”€â”€ */
.tabs{
  display:flex;gap:4px;
  background:var(--cream);
  border:1px solid var(--ivory);
  border-radius:var(--r-md);
  padding:5px;
  margin-bottom:30px;
  width:fit-content;
}
.tab-btn{
  padding:10px 22px;border-radius:9px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:400;
  border:none;background:none;cursor:pointer;
  color:var(--grey);
  display:flex;align-items:center;gap:8px;
  transition:all var(--transition);
  white-space:nowrap;
}
.tab-btn .tab-icon{font-size:15px;}
.tab-btn.active{
  background:white;color:var(--forest);font-weight:500;
  box-shadow:0 1px 8px rgba(0,0,0,0.08);
}
.tab-btn:hover:not(.active){color:var(--ink);}

/* â”€â”€ TAB PANELS â”€â”€ */
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* Shared label */
.input-label{
  font-size:10.5px;font-weight:500;letter-spacing:0.18em;text-transform:uppercase;
  color:var(--moss);margin-bottom:10px;display:block;
}
.input-hint{font-size:13px;color:var(--grey);margin-bottom:16px;line-height:1.6;}

/* â”€â”€ TEXT TAB â”€â”€ */
textarea#textInput{
  width:100%;min-height:130px;resize:vertical;
  border:1.5px solid var(--ivory);border-radius:10px;
  padding:16px 18px;
  font-family:'DM Sans',sans-serif;font-size:13.5px;font-weight:300;
  color:var(--ink);background:var(--cream);
  line-height:1.7;transition:border-color var(--transition),box-shadow var(--transition);
}
textarea#textInput:focus{outline:none;border-color:var(--moss);box-shadow:0 0 0 3px rgba(61,92,67,0.07);}
textarea#textInput::placeholder{color:var(--grey-lt);}

/* â”€â”€ UPLOAD TAB â”€â”€ */
.drop-zone{
  border:2px dashed var(--parchmt);
  border-radius:var(--r-lg);
  padding:48px 32px;
  text-align:center;
  cursor:pointer;
  transition:all var(--transition);
  background:var(--cream);
  position:relative;
}
.drop-zone:hover,.drop-zone.dragover{
  border-color:var(--sage);background:rgba(126,168,122,0.05);
}
.drop-zone input[type=file]{
  position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;
}
.drop-icon{font-size:36px;margin-bottom:12px;opacity:0.5;}
.drop-title{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:300;color:var(--forest);margin-bottom:6px;}
.drop-subtitle{font-size:12.5px;color:var(--grey);}
.drop-formats{
  display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:16px;
}
.format-tag{
  font-size:11px;letter-spacing:0.08em;padding:3px 10px;border-radius:20px;
  background:var(--ivory);color:var(--grey);
}
.image-preview-wrap{display:none;margin-top:20px;}
.image-preview-wrap.visible{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;}
.image-preview{
  width:180px;height:180px;object-fit:cover;border-radius:var(--r-md);
  border:1px solid var(--ivory);box-shadow:var(--shadow);
}
.img-info{flex:1;min-width:140px;}
.img-filename{font-size:13.5px;font-weight:500;color:var(--ink);margin-bottom:6px;}
.img-size{font-size:12px;color:var(--grey);}
.btn-remove-img{
  margin-top:12px;font-size:12px;color:var(--blush);
  background:none;border:1px solid var(--blush-lt);border-radius:6px;
  padding:5px 12px;cursor:pointer;font-family:'DM Sans',sans-serif;
  transition:all var(--transition);
}
.btn-remove-img:hover{background:var(--blush-lt);}

/* â”€â”€ SCAN TAB â”€â”€ */
.scan-container{position:relative;}
.camera-frame{
  width:100%;aspect-ratio:4/3;max-height:380px;
  background:#0a0a0a;border-radius:var(--r-lg);overflow:hidden;
  position:relative;display:flex;align-items:center;justify-content:center;
}
#videoEl{width:100%;height:100%;object-fit:cover;display:none;}
#canvasEl{display:none;}
.camera-overlay{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  color:white;text-align:center;gap:12px;
}
.camera-overlay.hidden{display:none;}
.camera-overlay .cam-icon{font-size:40px;opacity:0.4;}
.camera-overlay p{font-size:13px;color:rgba(255,255,255,0.6);max-width:240px;line-height:1.5;}

/* Viewfinder guide */
.viewfinder{
  position:absolute;
  inset:10%;
  border:2px solid rgba(255,255,255,0.35);
  border-radius:8px;
  pointer-events:none;
  display:none;
}
.viewfinder.visible{display:block;}
.viewfinder::before,.viewfinder::after,
.vf-tl::before,.vf-tl::after{
  content:'';position:absolute;
  width:20px;height:20px;
  border-color:white;border-style:solid;border-width:0;
}
.vf-corner{position:absolute;width:20px;height:20px;}
.vf-corner.tl{top:-2px;left:-2px;border-top:2px solid white;border-left:2px solid white;border-radius:3px 0 0 0;}
.vf-corner.tr{top:-2px;right:-2px;border-top:2px solid white;border-right:2px solid white;border-radius:0 3px 0 0;}
.vf-corner.bl{bottom:-2px;left:-2px;border-bottom:2px solid white;border-left:2px solid white;border-radius:0 0 0 3px;}
.vf-corner.br{bottom:-2px;right:-2px;border-bottom:2px solid white;border-right:2px solid white;border-radius:0 0 3px 0;}

.scan-controls{
  display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;align-items:center;
}
#capturePreview{
  width:160px;height:120px;object-fit:cover;
  border-radius:var(--r-md);border:1px solid var(--ivory);
  box-shadow:var(--shadow);display:none;
}
#capturePreview.visible{display:block;}

/* â”€â”€ ACTIONS ROW â”€â”€ */
.actions-row{
  display:flex;gap:10px;margin-top:20px;
  align-items:center;flex-wrap:wrap;
}
.btn-primary{
  background:var(--forest);color:white;
  border:none;border-radius:9px;
  padding:14px 32px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;
  letter-spacing:0.04em;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  transition:background var(--transition),box-shadow var(--transition),transform 0.1s;
}
.btn-primary:hover{background:var(--moss);box-shadow:0 4px 18px rgba(38,61,46,0.22);}
.btn-primary:active{transform:translateY(1px);}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;}

.btn-secondary{
  background:none;border:1.5px solid var(--ivory);border-radius:9px;
  padding:12px 22px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:400;color:var(--grey);
  cursor:pointer;transition:all var(--transition);
}
.btn-secondary:hover{border-color:var(--moss);color:var(--forest);}

.btn-ghost{
  background:none;border:none;
  font-family:'DM Sans',sans-serif;font-size:12.5px;color:var(--grey-lt);
  cursor:pointer;transition:color var(--transition);padding:0 6px;
}
.btn-ghost:hover{color:var(--blush);}

.btn-cam{
  background:white;border:1.5px solid var(--ivory);border-radius:9px;
  padding:12px 20px;
  font-family:'DM Sans',sans-serif;font-size:13px;font-weight:400;color:var(--ink);
  cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:all var(--transition);
}
.btn-cam:hover{border-color:var(--moss);color:var(--forest);}
.btn-cam-capture{
  background:var(--blush);color:white;border:none;border-radius:50%;
  width:52px;height:52px;cursor:pointer;font-size:20px;
  transition:all var(--transition);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 12px rgba(201,123,110,0.3);
}
.btn-cam-capture:hover{background:var(--forest);box-shadow:0 4px 18px rgba(38,61,46,0.25);}
.btn-cam-capture:disabled{opacity:0.4;cursor:not-allowed;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOADING STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loadingSection{display:none;text-align:center;padding:60px 20px;}
#loadingSection.visible{display:block;}
.loading-orb{
  width:72px;height:72px;border-radius:50%;
  border:2px solid var(--ivory);
  border-top-color:var(--moss);
  animation:spin 1s linear infinite;
  margin:0 auto 24px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-title{
  font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;
  color:var(--forest);margin-bottom:8px;
}
.loading-sub{font-size:13px;color:var(--grey);line-height:1.6;}
.loading-steps{
  display:flex;gap:20px;justify-content:center;margin-top:24px;flex-wrap:wrap;
}
.load-step{
  font-size:12px;color:var(--grey-lt);
  display:flex;align-items:center;gap:6px;
}
.load-step.active{color:var(--moss);}
.load-step .step-dot{
  width:7px;height:7px;border-radius:50%;
  background:var(--parchmt);transition:background 0.4s;
}
.load-step.active .step-dot{background:var(--sage);animation:pulse 1.2s infinite;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESULTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#resultsSection{display:none;}
#resultsSection.visible{display:block;}

/* â”€â”€ Product title â”€â”€ */
.product-banner{
  background:white;border:1px solid rgba(38,61,46,0.08);
  border-radius:var(--r-lg);padding:24px 32px;
  margin-bottom:28px;box-shadow:var(--shadow);
  display:flex;align-items:center;gap:20px;flex-wrap:wrap;
}
.product-icon{font-size:28px;}
.product-name{
  font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:400;
  color:var(--forest);
}
.product-name-sub{font-size:12.5px;color:var(--grey);margin-top:2px;}
.btn-new-analysis{margin-left:auto;}

/* â”€â”€ Stats â”€â”€ */
.stats-row{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
  gap:14px;margin-bottom:28px;
}
.stat-card{
  background:white;border:1px solid rgba(38,61,46,0.07);
  border-radius:var(--r-md);padding:22px 18px;text-align:center;
  box-shadow:var(--shadow);
  transition:transform var(--transition);cursor:default;
}
.stat-card:hover{transform:translateY(-2px);}
.stat-num{
  font-family:'Cormorant Garamond',serif;font-size:46px;font-weight:300;
  line-height:1;margin-bottom:6px;
}
.stat-label{font-size:10.5px;font-weight:500;letter-spacing:0.13em;text-transform:uppercase;}
.stat-total .stat-num{color:var(--forest);}   .stat-total .stat-label{color:var(--moss);}
.stat-safe .stat-num{color:var(--safe-fg);}    .stat-safe .stat-label{color:var(--safe-fg);}
.stat-caution .stat-num{color:var(--caution-fg);} .stat-caution .stat-label{color:var(--caution-fg);}
.stat-flag .stat-num{color:var(--flag-fg);}    .stat-flag .stat-label{color:var(--flag-fg);}

/* â”€â”€ Summary note â”€â”€ */
.summary-notes{
  background:white;border:1px solid rgba(38,61,46,0.08);
  border-radius:var(--r-md);padding:22px 28px;
  margin-bottom:28px;box-shadow:var(--shadow);
  display:grid;grid-template-columns:1fr 1fr;gap:18px;
}
@media(max-width:640px){.summary-notes{grid-template-columns:1fr;}}
.note-item{}
.note-label{
  font-size:10px;font-weight:500;letter-spacing:0.18em;text-transform:uppercase;
  color:var(--grey-lt);margin-bottom:6px;
}
.note-text{font-size:13px;color:var(--ink);line-height:1.6;}

/* â”€â”€ Top concerns banner â”€â”€ */
.concerns-banner{
  border-radius:var(--r-md);padding:16px 22px;
  margin-bottom:28px;display:flex;align-items:flex-start;gap:14px;
}
.concerns-banner.safe-banner{background:var(--safe-bg);border:1px solid rgba(31,92,24,0.15);}
.concerns-banner.caution-banner{background:var(--caution-bg);border:1px solid rgba(122,74,0,0.15);}
.concerns-banner.flag-banner{background:var(--flag-bg);border:1px solid rgba(122,31,20,0.18);}
.concerns-banner-icon{font-size:18px;margin-top:1px;}
.concerns-banner-text{flex:1;}
.concerns-banner-title{font-size:13px;font-weight:500;margin-bottom:4px;}
.safe-banner .concerns-banner-title{color:var(--safe-fg);}
.caution-banner .concerns-banner-title{color:var(--caution-fg);}
.flag-banner .concerns-banner-title{color:var(--flag-fg);}
.concerns-list-inline{
  font-size:12.5px;color:var(--grey);display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;
}
.concern-chip{
  padding:3px 11px;border-radius:20px;font-size:12px;
}
.flag-banner .concern-chip{background:var(--flag-bg);color:var(--flag-fg);border:1px solid rgba(122,31,20,0.15);}
.caution-banner .concern-chip{background:var(--caution-bg);color:var(--caution-fg);border:1px solid rgba(122,74,0,0.12);}

/* â”€â”€ Filter bar â”€â”€ */
.filter-bar{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:24px;
}
.filter-label-txt{
  font-size:11px;font-weight:500;letter-spacing:0.14em;text-transform:uppercase;
  color:var(--grey-lt);margin-right:4px;
}
.filter-pill{
  border:1.5px solid var(--ivory);border-radius:30px;
  padding:7px 18px;
  font-family:'DM Sans',sans-serif;font-size:12.5px;font-weight:400;
  cursor:pointer;background:white;color:var(--grey);
  transition:all 0.18s;display:flex;align-items:center;gap:6px;
}
.filter-pill .pill-count{
  background:var(--ivory);border-radius:20px;
  padding:1px 7px;font-size:11px;font-weight:500;color:var(--grey);
}
.filter-pill:hover{border-color:var(--sage-lt);color:var(--forest);}
.filter-pill.active{background:var(--forest);color:white;border-color:var(--forest);}
.filter-pill.active .pill-count{background:rgba(255,255,255,0.2);color:white;}
.filter-pill.f-safe.active{background:var(--safe-fg);border-color:var(--safe-fg);}
.filter-pill.f-caution.active{background:var(--caution-fg);border-color:var(--caution-fg);}
.filter-pill.f-flag.active{background:var(--flag-fg);border-color:var(--flag-fg);}

/* â”€â”€ Ingredient cards â”€â”€ */
#ingredientsGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(310px,1fr));
  gap:16px;
}

.ing-card{
  background:white;
  border:1px solid rgba(38,61,46,0.07);
  border-radius:var(--r-lg);overflow:hidden;
  box-shadow:var(--shadow);
  transition:transform var(--transition),box-shadow var(--transition);
  animation:cardIn 0.3s ease both;
}
.ing-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);}

@keyframes cardIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* Card accent line */
.card-accent{height:3px;}
.card-accent.safe{background:linear-gradient(90deg,#52A549,#A8D4A2);}
.card-accent.caution{background:linear-gradient(90deg,#E8940A,#F5C86A);}
.card-accent.flag{background:linear-gradient(90deg,#D0392B,#E88A85);}

.card-head{padding:16px 18px 12px;display:flex;align-items:flex-start;gap:12px;}
.safety-indicator{
  flex-shrink:0;width:28px;height:28px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:13px;
  margin-top:2px;
}
.ind-safe{background:var(--safe-bg);}
.ind-caution{background:var(--caution-bg);}
.ind-flag{background:var(--flag-bg);}

.card-head-text{flex:1;min-width:0;}
.card-name{font-size:14px;font-weight:500;color:var(--ink);line-height:1.3;margin-bottom:2px;}
.card-inci{
  font-family:'Cormorant Garamond',serif;font-style:italic;
  font-size:13px;color:var(--grey);line-height:1.3;
}
.card-badge{
  flex-shrink:0;
  font-size:10px;font-weight:500;letter-spacing:0.07em;text-transform:uppercase;
  padding:4px 10px;border-radius:20px;margin-top:3px;
  white-space:nowrap;
}
.badge-safe{background:var(--safe-bg);color:var(--safe-fg);}
.badge-caution{background:var(--caution-bg);color:var(--caution-fg);}
.badge-flag{background:var(--flag-bg);color:var(--flag-fg);}

.card-body{padding:0 18px 14px;}
.card-desc{font-size:12.5px;color:var(--grey);line-height:1.65;margin-bottom:12px;}

.card-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.cat-tag{
  font-size:11px;padding:3px 10px;border-radius:6px;
  background:var(--cream);border:1px solid var(--ivory);
  color:var(--forest);
}

.card-duo{display:flex;gap:16px;flex-wrap:wrap;}
.card-list-block{flex:1;min-width:100px;}
.card-list-title{
  font-size:10px;font-weight:500;letter-spacing:0.14em;text-transform:uppercase;
  color:var(--grey-lt);margin-bottom:7px;
}
.card-list-block ul{list-style:none;}
.card-list-block ul li{
  font-size:12px;color:var(--ink);padding:2px 0 2px 14px;
  position:relative;line-height:1.5;
}
.card-list-block ul li::before{content:'Â·';position:absolute;left:0;font-size:16px;line-height:1.1;}
.benefits-block ul li::before{color:var(--sage);}
.concerns-block ul li::before{color:var(--blush);}
.card-list-block ul li.empty{color:var(--grey-lt);font-style:italic;}

.card-foot{
  padding:10px 18px 14px;border-top:1px solid var(--ivory);
  display:flex;gap:18px;flex-wrap:wrap;align-items:center;
}
.foot-item{font-size:11.5px;color:var(--grey);display:flex;align-items:center;gap:5px;}
.foot-item strong{font-weight:500;color:var(--ink);}
.foot-item .preg-icon{font-size:13px;}

/* Comedogenic meter */
.comed-meter{display:flex;gap:3px;align-items:center;}
.c-pip{
  width:9px;height:9px;border-radius:2px;
  background:var(--ivory);border:1px solid var(--parchmt);transition:background 0.2s;
}
.c-pip.lit{background:var(--blush);border-color:var(--blush);}

/* Banned chips */
.banned-wrap{
  padding:10px 18px 14px;border-top:1px solid var(--ivory);
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
}
.banned-label{font-size:10.5px;color:var(--grey);font-weight:500;}
.banned-chip{
  font-size:10.5px;padding:2px 9px;border-radius:4px;
  background:var(--flag-bg);color:var(--flag-fg);
  border:1px solid rgba(122,31,20,0.12);
}

/* â”€â”€ Empty filter state â”€â”€ */
.empty-filter{
  grid-column:1/-1;text-align:center;padding:48px;
  color:var(--grey-lt);
}
.empty-filter p{font-size:14px;margin-top:8px;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ERROR STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#errorSection{display:none;margin-bottom:24px;}
#errorSection.visible{display:block;}
.error-box{
  background:var(--flag-bg);border:1px solid rgba(122,31,20,0.15);
  border-radius:var(--r-md);padding:18px 22px;
  display:flex;align-items:flex-start;gap:14px;
}
.error-icon{font-size:18px;flex-shrink:0;}
.error-text{flex:1;}
.error-title{font-size:13.5px;font-weight:500;color:var(--flag-fg);margin-bottom:4px;}
.error-msg{font-size:12.5px;color:var(--grey);line-height:1.6;}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   FOOTER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
footer{
  position:relative;z-index:5;
  border-top:1px solid var(--ivory);
  padding:28px 64px;
  display:flex;gap:16px;align-items:center;flex-wrap:wrap;justify-content:space-between;
}
.footer-note{font-size:11.5px;color:var(--grey-lt);line-height:1.6;max-width:560px;}
.footer-note strong{font-weight:500;color:var(--grey);}
.footer-badge{
  font-size:11px;letter-spacing:0.06em;
  color:var(--grey-lt);display:flex;align-items:center;gap:6px;
}
.footer-badge::before{content:'âœ¦';}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESPONSIVE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  header{padding:28px 24px 24px;}
  .logo-title{font-size:38px;}
  main{padding:28px 20px 60px;}
  .input-card{padding:24px;}
  .tabs{width:100%;justify-content:stretch;}
  .tab-btn{flex:1;justify-content:center;padding:9px 10px;font-size:12px;}
  #ingredientsGrid{grid-template-columns:1fr;}
  .stats-row{grid-template-columns:repeat(2,1fr);}
  footer{padding:20px 24px;}
}
</style>
</head>
<body>

<!-- BG -->
<div class="bg-orb bg-orb-1"></div>
<div class="bg-orb bg-orb-2"></div>
<div class="bg-orb bg-orb-3"></div>

<!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
<header>
  <div class="header-left">
    <div class="logo-eyebrow">Ingredient Intelligence</div>
    <div class="logo-title">Skin<em>sight</em></div>
    <div class="header-tagline">Decode what's really inside your skincare â€” powered by Claude AI.</div>
  </div>
  <div class="header-badge">
    <span class="dot"></span>
    AI-Powered Analysis
  </div>
</header>

<!-- â”€â”€â”€ MAIN â”€â”€â”€ -->
<main>

  <!-- â•â•â• INPUT CARD â•â•â• -->
  <div class="input-card" id="inputCard">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('text',this)">
        <span class="tab-icon">âœï¸</span> Type
      </button>
      <button class="tab-btn" onclick="switchTab('upload',this)">
        <span class="tab-icon">ğŸ“·</span> Upload Photo
      </button>
      <button class="tab-btn" onclick="switchTab('scan',this)">
        <span class="tab-icon">ğŸ“¡</span> Live Scan
      </button>
    </div>

    <!-- â”€â”€ TEXT TAB â”€â”€ -->
    <div class="tab-panel active" id="panel-text">
      <label class="input-label" for="textInput">Product Name or Ingredient List</label>
      <p class="input-hint">
        Type a product name like <em>"CeraVe Moisturizing Cream"</em> â€” or paste the full ingredient list straight from the label.
      </p>
      <textarea id="textInput" placeholder="e.g.  CeraVe Moisturizing Cream
â€” or â€”
Water, Glycerin, Niacinamide, Retinol, Fragrance, Phenoxyethanol..."></textarea>
      <div class="actions-row">
        <button class="btn-primary" onclick="runAnalysis('text')">
          âœ¦ Analyze Ingredients
        </button>
        <button class="btn-secondary" onclick="loadSample()">Try a Sample</button>
        <button class="btn-ghost" onclick="clearAll()">Clear</button>
      </div>
    </div>

    <!-- â”€â”€ UPLOAD TAB â”€â”€ -->
    <div class="tab-panel" id="panel-upload">
      <label class="input-label">Upload Label Photo</label>
      <p class="input-hint">Take a photo of the ingredients list on the back of your product and upload it here. Claude will read and analyze every ingredient.</p>

      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
        <div class="drop-icon">ğŸŒ¿</div>
        <div class="drop-title">Drop your photo here</div>
        <div class="drop-subtitle">or click to browse from your device</div>
        <div class="drop-formats">
          <span class="format-tag">JPG</span>
          <span class="format-tag">PNG</span>
          <span class="format-tag">WEBP</span>
          <span class="format-tag">HEIC</span>
        </div>
      </div>

      <div class="image-preview-wrap" id="imgPreviewWrap">
        <img class="image-preview" id="imgPreviewEl" src="" alt="Preview">
        <div class="img-info">
          <div class="img-filename" id="imgFilename"></div>
          <div class="img-size" id="imgFilesize"></div>
          <button class="btn-remove-img" onclick="removeUploadedImg()">âœ• Remove</button>
        </div>
      </div>

      <div class="actions-row">
        <button class="btn-primary" id="btnAnalyzeUpload" onclick="runAnalysis('upload')" disabled>
          âœ¦ Analyze Label
        </button>
      </div>
    </div>

    <!-- â”€â”€ SCAN TAB â”€â”€ -->
    <div class="tab-panel" id="panel-scan">
      <label class="input-label">Live Camera Scan</label>
      <p class="input-hint">Point your camera at the ingredient list on a product label. When it's clear and readable, hit capture â€” Claude will do the rest.</p>

      <div class="camera-frame" id="cameraFrame">
        <video id="videoEl" playsinline autoplay muted></video>
        <canvas id="canvasEl"></canvas>

        <!-- Viewfinder overlay -->
        <div class="viewfinder" id="viewfinder">
          <div class="vf-corner tl"></div>
          <div class="vf-corner tr"></div>
          <div class="vf-corner bl"></div>
          <div class="vf-corner br"></div>
        </div>

        <!-- Start prompt overlay -->
        <div class="camera-overlay" id="cameraOverlay">
          <div class="cam-icon">ğŸ“·</div>
          <p>Camera preview will appear here.<br>Grant camera permission to begin.</p>
        </div>
      </div>

      <div class="scan-controls">
        <button class="btn-cam" id="btnStartCam" onclick="startCamera()">ğŸ“· Start Camera</button>
        <button class="btn-cam-capture" id="btnCapture" onclick="captureFrame()" disabled title="Capture">â¬¤</button>
        <button class="btn-cam" id="btnStopCam" onclick="stopCamera()" style="display:none">â¹ Stop</button>
        <img id="capturePreview" alt="Captured frame">
      </div>

      <div class="actions-row">
        <button class="btn-primary" id="btnAnalyzeScan" onclick="runAnalysis('scan')" disabled>
          âœ¦ Analyze Captured Image
        </button>
        <button class="btn-ghost" onclick="clearCapture()">Clear Capture</button>
      </div>
    </div>

  </div><!-- /input-card -->

  <!-- â•â•â• ERROR â•â•â• -->
  <div id="errorSection">
    <div class="error-box">
      <span class="error-icon">âš ï¸</span>
      <div class="error-text">
        <div class="error-title">Analysis Failed</div>
        <div class="error-msg" id="errorMsg">Something went wrong. Please try again.</div>
      </div>
    </div>
  </div>

  <!-- â•â•â• LOADING â•â•â• -->
  <div id="loadingSection">
    <div class="loading-orb"></div>
    <div class="loading-title">Analyzing Ingredientsâ€¦</div>
    <div class="loading-sub">Claude AI is identifying and evaluating every ingredient</div>
    <div class="loading-steps">
      <div class="load-step active" id="step1"><span class="step-dot"></span> Extracting ingredients</div>
      <div class="load-step" id="step2"><span class="step-dot"></span> Looking up safety data</div>
      <div class="load-step" id="step3"><span class="step-dot"></span> Generating report</div>
    </div>
  </div>

  <!-- â•â•â• RESULTS â•â•â• -->
  <div id="resultsSection">

    <!-- Product banner -->
    <div class="product-banner" id="productBanner" style="display:none;">
      <span class="product-icon">ğŸ§´</span>
      <div>
        <div class="product-name" id="productNameEl"></div>
        <div class="product-name-sub">AI-identified product</div>
      </div>
      <button class="btn-secondary btn-new-analysis" onclick="resetToInput()">+ New Analysis</button>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-bottom:20px;" id="newAnalysisRow">
      <button class="btn-secondary" onclick="resetToInput()">+ New Analysis</button>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card stat-total"><div class="stat-num" id="statTotal">0</div><div class="stat-label">Total Found</div></div>
      <div class="stat-card stat-safe"><div class="stat-num" id="statSafe">0</div><div class="stat-label">Safe</div></div>
      <div class="stat-card stat-caution"><div class="stat-num" id="statCaution">0</div><div class="stat-label">Caution</div></div>
      <div class="stat-card stat-flag"><div class="stat-num" id="statFlag">0</div><div class="stat-label">Flagged</div></div>
    </div>

    <!-- Summary notes -->
    <div class="summary-notes" id="summaryNotes"></div>

    <!-- Top concerns -->
    <div class="concerns-banner" id="concernsBanner" style="display:none;"></div>

    <!-- Filter bar -->
    <div class="filter-bar">
      <span class="filter-label-txt">Show:</span>
      <button class="filter-pill active" data-filter="all" onclick="setFilter('all',this)">
        All <span class="pill-count" id="fc-all">0</span>
      </button>
      <button class="filter-pill f-safe" data-filter="safe" onclick="setFilter('safe',this)">
        Safe <span class="pill-count" id="fc-safe">0</span>
      </button>
      <button class="filter-pill f-caution" data-filter="caution" onclick="setFilter('caution',this)">
        Caution <span class="pill-count" id="fc-caution">0</span>
      </button>
      <button class="filter-pill f-flag" data-filter="flag" onclick="setFilter('flag',this)">
        Flagged <span class="pill-count" id="fc-flag">0</span>
      </button>
    </div>

    <!-- Ingredient cards grid -->
    <div id="ingredientsGrid"></div>

  </div><!-- /resultsSection -->

</main>

<!-- â”€â”€â”€ FOOTER â”€â”€â”€ -->
<footer>
  <p class="footer-note">
    <strong>Educational use only.</strong> Skinsight provides general ingredient information based on available research and databases (EWG, CosIng, dermatological literature). Always consult a dermatologist for personalized skincare advice. Ingredient safety can vary based on concentration, formulation, and individual skin type.
  </p>
  <div class="footer-badge">Powered by Claude AI</div>
</footer>


<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let uploadedFile = null;
let capturedDataUrl = null;
let capturedMimeType = null;
let currentStream = null;
let allIngredients = [];
let activeFilter = 'all';
let loadingStepTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name, btn) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  btn.classList.add('active');
  hideError();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSample() {
  document.getElementById('textInput').value =
    `Water, Glycerin, Niacinamide, Sodium Hyaluronate, Dimethicone, Cetyl Alcohol, Glycolic Acid, Phenoxyethanol, Retinol, Tocopherol, Fragrance, Zinc Oxide, Salicylic Acid, Centella Asiatica Extract, Caffeine, Linalool, DMDM Hydantoin, Cyclopentasiloxane, Oxybenzone`;
}

function clearAll() {
  document.getElementById('textInput').value = '';
  hideError();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  setUploadedFile(file);
}

// Drag & drop
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) setUploadedFile(file);
});

function setUploadedFile(file) {
  uploadedFile = file;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('imgPreviewEl').src = ev.target.result;
    document.getElementById('imgPreviewWrap').classList.add('visible');
    document.getElementById('imgFilename').textContent = file.name;
    document.getElementById('imgFilesize').textContent = formatBytes(file.size);
    document.getElementById('btnAnalyzeUpload').disabled = false;
  };
  reader.readAsDataURL(file);
}

function removeUploadedImg() {
  uploadedFile = null;
  document.getElementById('imgPreviewWrap').classList.remove('visible');
  document.getElementById('imgPreviewEl').src = '';
  document.getElementById('fileInput').value = '';
  document.getElementById('btnAnalyzeUpload').disabled = true;
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMERA / LIVE SCAN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1080 } }
    });
    currentStream = stream;
    const video = document.getElementById('videoEl');
    video.srcObject = stream;
    video.style.display = 'block';
    document.getElementById('cameraOverlay').classList.add('hidden');
    document.getElementById('viewfinder').classList.add('visible');
    document.getElementById('btnCapture').disabled = false;
    document.getElementById('btnStartCam').style.display = 'none';
    document.getElementById('btnStopCam').style.display = 'flex';
  } catch (err) {
    showError('Camera access denied or unavailable. ' + err.message + '. Try the Upload tab instead.');
  }
}

function stopCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
    currentStream = null;
  }
  const video = document.getElementById('videoEl');
  video.style.display = 'none';
  video.srcObject = null;
  document.getElementById('cameraOverlay').classList.remove('hidden');
  document.getElementById('viewfinder').classList.remove('visible');
  document.getElementById('btnCapture').disabled = true;
  document.getElementById('btnStartCam').style.display = 'flex';
  document.getElementById('btnStopCam').style.display = 'none';
}

function captureFrame() {
  const video = document.getElementById('videoEl');
  const canvas = document.getElementById('canvasEl');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
  capturedDataUrl = dataUrl;
  capturedMimeType = 'image/jpeg';

  const preview = document.getElementById('capturePreview');
  preview.src = dataUrl;
  preview.classList.add('visible');
  document.getElementById('btnAnalyzeScan').disabled = false;

  // Flash effect
  const frame = document.getElementById('cameraFrame');
  frame.style.filter = 'brightness(2)';
  setTimeout(() => { frame.style.filter = ''; }, 120);
}

function clearCapture() {
  capturedDataUrl = null;
  capturedMimeType = null;
  const preview = document.getElementById('capturePreview');
  preview.src = '';
  preview.classList.remove('visible');
  document.getElementById('btnAnalyzeScan').disabled = true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAnalysis(mode) {
  hideError();

  let payload = {};

  if (mode === 'text') {
    const text = document.getElementById('textInput').value.trim();
    if (!text) { showError('Please enter a product name or ingredient list.'); return; }
    payload = { mode: 'text', content: text };
  }
  else if (mode === 'upload') {
    if (!uploadedFile) { showError('Please select an image file first.'); return; }
    const base64 = await fileToBase64(uploadedFile);
    payload = { mode: 'image', content: base64, mimeType: uploadedFile.type || 'image/jpeg' };
  }
  else if (mode === 'scan') {
    if (!capturedDataUrl) { showError('Please capture an image first.'); return; }
    const base64 = capturedDataUrl.split(',')[1];
    payload = { mode: 'image', content: base64, mimeType: capturedMimeType };
  }

  showLoading();
  startLoadingSteps();

  try {
    const res = await fetch('/api/analyze', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || `HTTP ${res.status}`);
    }

    hideLoading();
    renderResults(data);
  } catch (err) {
    hideLoading();
    showError('Analysis failed: ' + err.message + '. Make sure the ANTHROPIC_API_KEY environment variable is set in your Netlify project.');
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading() {
  document.getElementById('inputCard').style.display = 'none';
  document.getElementById('loadingSection').classList.add('visible');
  document.getElementById('resultsSection').classList.remove('visible');
}
function hideLoading() {
  document.getElementById('loadingSection').classList.remove('visible');
  clearInterval(loadingStepTimer);
  // Reset steps
  ['step1','step2','step3'].forEach(id => document.getElementById(id).classList.remove('active'));
  document.getElementById('step1').classList.add('active');
}

function startLoadingSteps() {
  document.getElementById('step1').classList.add('active');
  document.getElementById('step2').classList.remove('active');
  document.getElementById('step3').classList.remove('active');
  let step = 1;
  loadingStepTimer = setInterval(() => {
    step++;
    if (step > 3) { clearInterval(loadingStepTimer); return; }
    document.getElementById('step' + step).classList.add('active');
  }, 1800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderResults(data) {
  allIngredients = data.ingredients || [];
  const summary = data.summary || {};

  // Product name
  const banner = document.getElementById('productBanner');
  const newRow = document.getElementById('newAnalysisRow');
  if (data.productName) {
    document.getElementById('productNameEl').textContent = data.productName;
    banner.style.display = 'flex';
    newRow.style.display = 'none';
  } else {
    banner.style.display = 'none';
    newRow.style.display = 'flex';
  }

  // Stats
  document.getElementById('statTotal').textContent = allIngredients.length;
  document.getElementById('statSafe').textContent = summary.safeCount ?? allIngredients.filter(i => i.safety === 'safe').length;
  document.getElementById('statCaution').textContent = summary.cautionCount ?? allIngredients.filter(i => i.safety === 'caution').length;
  document.getElementById('statFlag').textContent = summary.flagCount ?? allIngredients.filter(i => i.safety === 'flag').length;

  // Filter counts
  const counts = {
    all: allIngredients.length,
    safe: allIngredients.filter(i => i.safety === 'safe').length,
    caution: allIngredients.filter(i => i.safety === 'caution').length,
    flag: allIngredients.filter(i => i.safety === 'flag').length,
  };
  Object.entries(counts).forEach(([k,v]) => {
    const el = document.getElementById('fc-' + k);
    if (el) el.textContent = v;
  });

  // Summary notes
  const notesEl = document.getElementById('summaryNotes');
  notesEl.innerHTML = '';
  if (summary.skinTypeNotes) {
    notesEl.innerHTML += `<div class="note-item"><div class="note-label">Skin Suitability</div><div class="note-text">${escHtml(summary.skinTypeNotes)}</div></div>`;
  }
  if (summary.pregnancyNote) {
    notesEl.innerHTML += `<div class="note-item"><div class="note-label">Pregnancy Safety</div><div class="note-text">${escHtml(summary.pregnancyNote)}</div></div>`;
  }
  if (!notesEl.innerHTML) notesEl.style.display = 'none';
  else notesEl.style.display = 'grid';

  // Top concerns banner
  const bannerEl = document.getElementById('concernsBanner');
  const safety = summary.overallSafety || (summary.flagCount > 0 ? 'flag' : summary.cautionCount > 0 ? 'caution' : 'safe');
  const bannerClass = safety === 'flag' ? 'flag-banner' : safety === 'caution' ? 'caution-banner' : 'safe-banner';
  const bannerIcon = safety === 'flag' ? 'ğŸš©' : safety === 'caution' ? 'âš ï¸' : 'âœ…';
  const bannerTitle = safety === 'flag' ? 'Flagged Ingredients Found' : safety === 'caution' ? 'Some Ingredients Need Caution' : 'Ingredients Look Generally Safe';

  let bannerHtml = `<span class="concerns-banner-icon">${bannerIcon}</span>
    <div class="concerns-banner-text">
      <div class="concerns-banner-title">${bannerTitle}</div>`;

  if (summary.topConcerns && summary.topConcerns.length > 0) {
    bannerHtml += `<div class="concerns-list-inline">`;
    summary.topConcerns.forEach(c => {
      bannerHtml += `<span class="concern-chip">${escHtml(c)}</span>`;
    });
    bannerHtml += `</div>`;
  }
  bannerHtml += `</div>`;

  bannerEl.className = `concerns-banner ${bannerClass}`;
  bannerEl.innerHTML = bannerHtml;
  bannerEl.style.display = 'flex';

  // Render cards
  activeFilter = 'all';
  document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
  document.querySelector('.filter-pill[data-filter="all"]').classList.add('active');
  renderCards();

  document.getElementById('resultsSection').classList.add('visible');
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderCards() {
  const grid = document.getElementById('ingredientsGrid');
  const filtered = activeFilter === 'all' ? allIngredients : allIngredients.filter(i => i.safety === activeFilter);
  grid.innerHTML = '';

  if (filtered.length === 0) {
    grid.innerHTML = `<div class="empty-filter">
      <div style="font-size:32px;opacity:0.3">ğŸŒ¿</div>
      <p>No ${activeFilter} ingredients found in this formula.</p>
    </div>`;
    return;
  }

  filtered.forEach((ing, idx) => {
    const card = buildCard(ing, idx);
    grid.appendChild(card);
  });
}

function buildCard(ing, idx) {
  const safety = ing.safety || 'safe';
  const indIcon = safety === 'safe' ? 'âœ“' : safety === 'caution' ? '!' : 'âœ•';
  const indClass = 'ind-' + safety;
  const badgeClass = 'badge-' + safety;
  const badgeText = safety === 'safe' ? 'Safe' : safety === 'caution' ? 'Caution' : 'Flagged';

  // Comedogenic pips
  const comed = Math.min(5, Math.max(0, ing.comedogenic ?? 0));
  let comedHtml = '<div class="comed-meter">';
  for (let i = 0; i < 5; i++) {
    comedHtml += `<div class="c-pip${i < comed ? ' lit' : ''}"></div>`;
  }
  comedHtml += '</div>';

  // Benefits
  const benefits = (ing.benefits || []).slice(0, 4);
  const benefitsHtml = benefits.length
    ? `<ul>${benefits.map(b => `<li>${escHtml(b)}</li>`).join('')}</ul>`
    : `<ul><li class="empty">â€”</li></ul>`;

  // Concerns
  const concerns = (ing.concerns || []).slice(0, 4);
  const concernsHtml = concerns.length
    ? `<ul>${concerns.map(c => `<li>${escHtml(c)}</li>`).join('')}</ul>`
    : `<ul><li class="empty">None noted</li></ul>`;

  // Categories
  const cats = (ing.category || []).slice(0, 4);
  const catsHtml = cats.map(c => `<span class="cat-tag">${escHtml(c)}</span>`).join('');

  // Pregnancy
  const preg = ing.pregnancySafe;
  const pregHtml = preg === true ? 'âœ… Pregnancy safe'
    : preg === false ? 'âŒ Avoid in pregnancy'
    : 'â” Consult doctor';

  // Banned regions
  const banned = ing.bannedRegions || [];
  const bannedHtml = banned.length > 0
    ? `<div class="banned-wrap"><span class="banned-label">Banned / Restricted:</span>${banned.map(r => `<span class="banned-chip">${escHtml(r)}</span>`).join('')}</div>`
    : '';

  // EWG
  const ewg = ing.ewgScore;
  const ewgHtml = ewg != null ? `<span>EWG <strong>${ewg}/10</strong></span>` : '';

  const card = document.createElement('div');
  card.className = 'ing-card';
  card.style.animationDelay = (idx * 0.04) + 's';
  card.innerHTML = `
    <div class="card-accent ${safety}"></div>
    <div class="card-head">
      <div class="safety-indicator ${indClass}">${indIcon}</div>
      <div class="card-head-text">
        <div class="card-name">${escHtml(ing.name || 'Unknown Ingredient')}</div>
        <div class="card-inci">${escHtml(ing.inci || '')}</div>
      </div>
      <div class="card-badge ${badgeClass}">${badgeText}</div>
    </div>
    <div class="card-body">
      <p class="card-desc">${escHtml(ing.description || '')}</p>
      ${catsHtml ? `<div class="card-tags">${catsHtml}</div>` : ''}
      <div class="card-duo">
        <div class="card-list-block benefits-block">
          <div class="card-list-title">Benefits</div>
          ${benefitsHtml}
        </div>
        <div class="card-list-block concerns-block">
          <div class="card-list-title">Concerns</div>
          ${concernsHtml}
        </div>
      </div>
    </div>
    <div class="card-foot">
      <div class="foot-item">
        <span>Comedogenic</span>
        ${comedHtml}
        <strong>${comed}/5</strong>
      </div>
      <div class="foot-item">
        <span class="preg-icon">${preg === true ? 'âœ…' : preg === false ? 'âŒ' : 'â”'}</span>
        <span>${preg === true ? 'Pregnancy safe' : preg === false ? 'Avoid in pregnancy' : 'Pregnancy: consult doctor'}</span>
      </div>
      ${ewgHtml ? `<div class="foot-item">${ewgHtml}</div>` : ''}
    </div>
    ${bannedHtml}
  `;
  return card;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(filter, btn) {
  activeFilter = filter;
  document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCards();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ERROR / RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showError(msg) {
  document.getElementById('errorMsg').textContent = msg;
  document.getElementById('errorSection').classList.add('visible');
  document.getElementById('inputCard').style.display = 'block';
}
function hideError() {
  document.getElementById('errorSection').classList.remove('visible');
}

function resetToInput() {
  document.getElementById('resultsSection').classList.remove('visible');
  document.getElementById('inputCard').style.display = 'block';
  document.getElementById('inputCard').scrollIntoView({ behavior: 'smooth' });
  allIngredients = [];
}

function escHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
</body>
</html>
